#!/usr/bin/env python
"""
Employ instance to do your bidding

Usage:
  employ --help
  employ --version
  employ help (commands | command <command> | regions)
  employ run <command> <config_file> [<setup_script> ...]

Global Options:
  -h, --help                    Show this message
  --version                     Show the version number

Help Commands:
  commands                      List all available commands
  command <command>             Print the docstring for the provided command
  regions                       List all available regions names
"""
from ConfigParser import RawConfigParser
import sys

from docopt import docopt

import employ
import employ.manager


def command_doc(command):
    all_commands = employ.manager.Manager.available_commands()
    if all_commands.get(command):
        print all_commands[command].__doc__
    else:
        sys.exit("Unknown command: '%s'" % command)


def list_commands(command=None):
    all_commands = employ.manager.Manager.available_commands()
    print "List of Available Commands:"
    for cls in all_commands:
        print "  %s" % cls


def list_regions():
    print "List of Available Regions:"
    for region in sorted(employ.manager.Manager.available_regions()):
        print "  %s" % region


def run(config_file, setup_scripts):
    config = RawConfigParser(allow_no_value=True)
    config.read(config_file)
    commands = []

    all_commands = employ.manager.Manager.available_commands()
    for command in config.sections():
        if command == "employ":
            continue
        if command not in all_commands:
            sys.exit("Unknown command '%s'" % command)
        commands.append(all_commands[command].from_config(config))
    manager = employ.manager.Manager.from_config(config)
    with manager:
        for setup_script in setup_scripts:
            manager.setup(setup_script)
        for command in commands:
            manager.run(command)


arguments = docopt(__doc__, help=True, version="employ %s" % employ.__version__)
if arguments["help"]:
    if arguments["commands"]:
        list_commands()
    elif arguments["command"] and arguments["<command>"]:
        command_doc(arguments["<command>"])
    elif arguments["regions"]:
        list_regions()
elif arguments["run"]:
    run(arguments["<config_file>"], arguments["<setup_script>"])
